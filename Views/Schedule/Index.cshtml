@using UCOMProject.Models
@using UCOMProject.Methods
@{
    ViewBag.Title = "出勤總覽";
    Employee emp = SessionEmp.CurrentEmp;
}

<h2 class="text-center">出勤總覽</h2>
<div class="mt-5">
    <div class="block">
        <div class="shift_block shiftA"></div><span>A班</span>&nbsp;&nbsp;&nbsp;
        <div class="shift_block"></div><span>B班</span>
    </div>
    <div id="calendar" class=""></div>
</div>


@section Script{
    <script src="~/Content/fullcalendar-6.1.4/dist/index.global.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('http://localhost:51010/api/apiSchedule', {
                headers: {
                    "ROLE_CODE": ["admin", "admin-leader"]
                }
            }).then(res => res.json()).then(result => {
                var myData = JSON.parse(result);
                var leaveCount = [];
                for (let key in myData.leaveNums) {
                    leaveCount.push({ dateCount: key, count: myData.leaveNums[key] });
                }
                console.log(myData.calendars);
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    eventSources: [
                        {
                            events: myData.calendars,//初始化events
                            defaultAllDay: true,
                            className: 'text-center badge badge-primary event_backColor',
                        }
                    ],
                    initialView: 'dayGridMonth',
                    height: 800,
                    headerToolbar: {
                        left: 'prev,next,today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    titleFormat: { year: 'numeric', month: 'short' },
                    buttonText: {
                        today: '今天',
                        month: '月',
                        week: '周',
                        day: '天',
                        list: '清單'
                    },
                    aspectRatio: 2,
                    dayMaxEvents: true,
                    dayCellClassNames: function (arg) {
                        let date = new Date(arg.date);
                        let result = myData.shifts[date.getMonth()].find(item => {
                            let check = new Date(item.checkDate).toLocaleDateString();
                            return check === date.toLocaleDateString();
                        })
                        if (result && result.isWork)
                            return 'shiftA';
                        else
                            return '';
                    },
                    dayCellContent: function (arg) {
                        //let leaveShow = leaveCount.find(item => {
                        //    let checkDate = new Date(arg.date).toLocaleDateString();
                        //    let leaveDate = new Date(item.dateCount).toLocaleDateString();
                        //    return checkDate === leaveDate;
                        //})
                        //let needTotal = 1;
                        //let div = document.createElement('div');
                        //div.classList.add('calendarFlex');
                        //let p = document.createElement('p');
                        //if (leaveShow) {
                        //    let total = needTotal - leaveShow.count < 0 ? `需求${needTotal - leaveShow.count}人` : '';
                        //    p.innerHTML = `<small class="badge badge-danger">${total}</small>`;
                        //} else {
                        //    p.innerHTML = '';
                        //}

                        //let day = document.createElement('p');
                        //day.innerHTML = arg.dayNumberText;
                        ////day.classList.add('calendarDayTxt');
                        //div.append(p);
                        //div.append(day);
                        //let arrayOfDomNodes = [div];
                        //return { domNodes: arrayOfDomNodes };
                    },
                    eventDataTransform: function (eventData) {
                        getLeaveNum();
                    },
                });
                calendar.render();
                function getLeaveNum(checkDate) {
                    let num = 0;
                    return num
                }
            });
        });
    </script>

}


@section Style{
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <style>
        .calendarFlex {
            display: flex;
            min-width: 100px;
            /*background-color: red;*/
            justify-content: space-between;
        }

        .calendarDayTxt {
            font-size: 1rem;
            font-weight: 800;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 50%;
            color: black;
        }
        .event_backColor{
            background-size:contain;
            background-repeat:no-repeat;
            background-position-x:5px;
        }
        .event_shiftA {
            background-image: url(/images/a.png);
        }
        .event_shiftB {
            background-image: url(/images/b.png);
        }
        .event_shiftW {
            background-image: url(/images/w.png);
        }
    </style>
}